<div class="login-wrapper">
    <div class="login-card row g-0">

      <!-- ZONE GAUCHE : IMAGE (Avec Logo & Texte) -->
      <div class="col-lg-6 col-md-12 visual-side position-relative d-none d-lg-flex">
          <!-- Logo sur l'image -->
          <div class="brand-logo-visual">
              <i class="fas fa-layer-group me-2"></i> Greco-Tickets
          </div>

          <!-- Texte Overlay en bas -->
          <div class="visual-content">
              <h1 class="visual-title">
                  Gérez plus intelligemment.<br>
                  Exportez plus vite.
              </h1>
              <p class="visual-desc">
                  Une plateforme puissante pour orchestrer vos tickets et collaborer sans friction.
              </p>
              <!-- Indicateurs de slide décoratifs -->
              <div class="slider-indicators">
                  <span class="active"></span><span></span><span></span>
              </div>
          </div>
      </div>

      <!-- ZONE DROITE : FORMULAIRES -->
      <div class="col-lg-6 col-md-12 form-side">
          
          <!-- ÉTAPE 0 : CREATION ADMINISTRATEUR -->
          @if (stepIndex === 0) {
            <div class="form-content fade-in">
                <h2 class="form-title">Initialisation</h2>
                <p class="sub-text mb-4">Configurez le compte administrateur principal.</p>

                <form (ngSubmit)="onSubmitAdminCreation()" #fAdmin="ngForm">
                    
                    <div class="row">
                        <div class="col-6">
                             <div class="input-group mb-3">
                                <label class="input-label">Nom</label>
                                <input [(ngModel)]="userRegister.nom" name="nom" type="text" class="modern-input" placeholder="Votre nom" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group mb-3">
                                <label class="input-label">Prénom</label>
                                <input [(ngModel)]="userRegister.prenom" name="prenom" type="text" class="modern-input" placeholder="Votre prénom" required>
                            </div>
                        </div>
                    </div>

                    <div class="input-group mb-3">
                        <label class="input-label">Email</label>
                        <input [(ngModel)]="userRegister.email" name="email" type="email" class="modern-input" placeholder="exemple@domaine.com" required>
                    </div>

                    <div class="input-group mb-3">
                        <label class="input-label">Téléphone</label>
                        <input [(ngModel)]="userRegister.telephone" name="telephone" type="tel" class="modern-input" placeholder="+33 6..." required>
                    </div>

                    <div class="input-group mb-3">
                        <label class="input-label">Identifiant (fixe)</label>
                        <input [(ngModel)]="userRegister.login" name="login" type="text" class="modern-input bg-light" readonly>
                    </div>

                    <div class="input-group mb-3 position-relative">
                        <label class="input-label">Mot de passe</label>
                        <input [(ngModel)]="userRegister.password" name="passwordCreate" [type]="vuecCreate ? 'text' : 'password'" 
                               class="modern-input" placeholder="Mot de passe sécurisé" required minlength="6">
                         <i class="far password-toggle" [ngClass]="{'fa-eye': !vuecCreate, 'fa-eye-slash': vuecCreate}" 
                           (click)="togglePasswordVisibilityCreate()"></i>
                    </div>

                    <div class="input-group mb-4">
                        <label class="input-label">Confirmation</label>
                        <input [(ngModel)]="userRegister.passwordConfirm" name="passwordConfirm" [type]="vuecCreate ? 'text' : 'password'" 
                               class="modern-input" placeholder="Répétez le mot de passe" required>
                    </div>

                    @if (isLoginFailed) {
                        <div class="alert alert-danger mb-3">{{ errorMessage }}</div>
                    }

                    <button class="submit-btn" [disabled]="loading || fAdmin.invalid">
                        @if (!loading) { <span>Créer l'Administrateur</span> } 
                        @else { <span><i class="fas fa-spinner fa-spin me-2"></i> Initialisation...</span> }
                    </button>
                </form>
            </div>
          }

          <!-- ÉTAPE 1 : LOGIN -->
          @if (stepIndex === 1) {
            <div class="form-content fade-in">
                <h2 class="form-title">Welcome Back!</h2>
                <p class="sub-text mb-4">Connectez-vous pour accéder à votre dashboard.</p>

                <form (ngSubmit)="onSubmit()" #f="ngForm">
                    @if (isSessionExpired) {
                        <div class="alert alert-warning mb-3">
                           <i class="fas fa-exclamation-triangle me-2"></i> {{ 'session expiree' | translate }}
                        </div>
                    }

                    <div class="input-group mb-3">
                        <label for="username" class="input-label">Identifiant</label>
                        <input [(ngModel)]="form.username" name="username" type="text" id="username" 
                               class="modern-input" placeholder="Entrez votre identifiant" required 
                               [class.is-invalid]="f.submitted && !form.username">
                    </div>

                    <div class="input-group mb-3 position-relative">
                        <label for="password" class="input-label">Mot de passe</label>
                        <input [(ngModel)]="form.password" name="password" [type]="vuec ? 'text' : 'password'" 
                               id="password" class="modern-input" placeholder="Entrez votre mot de passe" required>
                        <i class="far password-toggle" [ngClass]="{'fa-eye': !vuec, 'fa-eye-slash': vuec}" 
                           (click)="togglePasswordVisibilityCon()"></i>
                    </div>

                    @if (isLoginFailed) {
                        <div class="alert alert-danger mb-3">
                            {{ errorMessage || ('Identifiants incorrects' | translate) }}
                        </div>
                    }

                    <div class="d-flex justify-content-between align-items-center mb-4 form-extras">
                        <label class="remember-me d-flex align-items-center">
                            <input type="checkbox" class="me-2 custom-checkbox"> Se souvenir de moi
                        </label>
                        <a href="javascript:void(0)" class="forgot-link">Mot de passe oublié ?</a>
                    </div>

                    <button class="submit-btn mb-4" [disabled]="loading">
                        @if (!loading) { <span>Se connecter</span> } 
                        @else { <span><i class="fas fa-spinner fa-spin me-2"></i> Connexion...</span> }
                    </button>

                    <!-- Divider & Social (Style 'Continue with Google') -->
                    <div class="divider mb-3"><span>Ou continuer avec</span></div>
                    
                    <button type="button" class="social-btn mb-3">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" width="18" class="me-2">
                        Continuer avec Google
                    </button>

                    <div class="text-center mt-3">
                        <p class="sub-text">Vous n'avez pas de compte ? <a href="javascript:void(0)" class="forgot-link fw-bold">S'inscrire ici</a></p>
                    </div>
                </form>
            </div>
          }

          <!-- ÉTAPE 2 : OTP VERIFICATION -->
          @if (stepIndex === 2) {
            <div class="form-content fade-in text-center">
                <div class="icon-shield mb-3">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2 class="form-title">Vérification</h2>
                <p class="sub-text mb-4">
                    Entrez le code envoyé 
                    @if(modeVerif === 1) { <span>par email à <strong>{{ utilisateur.email }}</strong></span> }
                    @else { <span>par SMS au <strong>{{ utilisateur.telephone }}</strong></span> }
                </p>

                <div class="d-flex justify-content-center gap-2 mb-4">
                    @for (digit of otpDigits; track $index; let i = $index) {
                        <input #otpInput type="text" maxlength="1" 
                               class="otp-input modern-input text-center"
                               [(ngModel)]="otpDigits[i]" 
                               (input)="onInput($event, i)"
                               (keydown.backspace)="onBackspace(i)"
                               autocomplete="off">
                    }
                </div>

                <button class="submit-btn mb-4" (click)="verifierCode()" [disabled]="loading || otpValue.length < 6">
                    @if (!loading) { <span>Vérifier</span> } 
                    @else { <span><i class="fas fa-spinner fa-spin me-2"></i> Vérification...</span> }
                </button>

                <div class="text-muted small">
                    <p class="mb-2">Renvoyer le code dans <span class="fw-bold text-dark">{{ timerDisplay }}</span></p>
                    <a class="forgot-link cursor-pointer" (click)="renvoyerCode()" 
                       [class.disabled]="timer > 0" [style.cursor]="timer > 0 ? 'not-allowed' : 'pointer'">
                       Renvoyer maintenant
                    </a>
                </div>
                
                <button class="btn btn-link text-muted mt-3 text-decoration-none btn-sm" (click)="stepIndex = 1">
                    <i class="fas fa-arrow-left me-1"></i> Retour
                </button>
            </div>
          }

      </div>
    </div>
    
    <!-- Loader Global -->
    @if (waiter) {
        <div class="loader-overlay">
          <div class="spinner-border text-dark" role="status"></div>
        </div>
    }
</div>