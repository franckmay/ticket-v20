<div class="container-fluid p-0 overflow-hidden">
    <div class="row g-0 h-100">
      
      <!-- ZONE GAUCHE : VISUELS & PHYSIQUE -->
      <div class="col-lg-5 col-md-12 visual-side position-relative" id="visual-container">
          <canvas id="bg-animation"></canvas>
          
          <div class="hero-text">
              <h1>Greco<br>Tickets</h1>
              <p>{{ 'slogan' | translate }}</p>
          </div>

          <!-- Canvas Physique Matter.js -->
          <canvas id="physics-canvas"></canvas>

          <!-- Elements Physiques (Cartes flottantes) -->
          <div id="card-1" class="physics-dom-element highlight">
              <div class="icon-box"><i class="fas fa-ticket-alt"></i></div>
              <div><strong>Tickets</strong>Gestion agile</div>
          </div>
          <div id="card-2" class="physics-dom-element">
              <div class="icon-box"><i class="fas fa-chart-line"></i></div>
              <div><strong>Analytics</strong>Temps réel</div>
          </div>
          <div id="card-3" class="physics-dom-element">
              <div class="icon-box"><i class="fas fa-users"></i></div>
              <div><strong>Équipes</strong>Collaboration</div>
          </div>
      </div>

      <!-- ZONE DROITE : FORMULAIRES -->
      <div class="col-lg-7 col-md-12 form-side d-flex align-items-center justify-content-center">
          
          <!-- ÉTAPE 1 : LOGIN -->
          <div class="form-container w-100" style="max-width: 450px;" *ngIf="stepIndex === 1">
              <div class="brand-logo mb-4">
                  <i class="fas fa-layer-group me-2"></i> Greco-tickets
              </div>
              <h2 class="text-white mb-2">{{ 'Veuillez vous connecter pour continuer' | translate }}</h2>
              <p class="sub-text mb-4">Entrez vos identifiants pour accéder au dashboard.</p>

              <form (ngSubmit)="onSubmit()" #f="ngForm">
                  <!-- Alert Session Expirée -->
                  <div *ngIf="isSessionExpired" class="alert alert-warning mb-3 d-flex align-items-center">
                     <i class="fas fa-exclamation-triangle me-2"></i> {{ 'session expiree' | translate }}
                  </div>

                  <!-- Username Input -->
                  <div class="input-wrapper mb-4">
                      <input [(ngModel)]="form.username" name="username" type="text" id="username" 
                             class="modern-input" placeholder=" " required #username="ngModel"
                             [class.is-invalid]="f.submitted && username.invalid">
                      <label for="username" class="floating-label">{{ 'Identifiant' | translate }}</label>
                      <i class="far fa-envelope input-icon"></i>
                  </div>

                  <!-- Password Input -->
                  <div class="input-wrapper mb-4">
                      <input [(ngModel)]="form.password" name="password" [type]="vuec ? 'text' : 'password'" 
                             id="password" class="modern-input" placeholder=" " required #password="ngModel">
                      <label for="password" class="floating-label">{{ 'password_label' | translate }}</label>
                      <i class="fas fa-lock input-icon"></i>
                      <i class="far" [ngClass]="{'fa-eye': !vuec, 'fa-eye-slash': vuec}" 
                         (click)="togglePasswordVisibilityCon()" class="password-toggle"></i>
                  </div>

                  <!-- Error Message -->
                  <div *ngIf="isLoginFailed" class="alert alert-danger-glass mb-3">
                      <i class="fas fa-times-circle me-2"></i> {{ errorMessage || ('Identifiants incorrects' | translate) }}
                  </div>

                  <div class="form-extras d-flex justify-content-between mb-4">
                      <label class="remember-me text-muted">
                          <input type="checkbox" class="me-2 accent-green"> Se souvenir de moi
                      </label>
                      <a href="javascript:void(0)" class="forgot-link">{{ 'mot de passe oublie' | translate }}</a>
                  </div>

                  <button class="submit-btn w-100" [disabled]="loading">
                      <span *ngIf="!loading">{{ 'sign_in_button' | translate }} <i class="fas fa-arrow-right ms-2"></i></span>
                      <span *ngIf="loading"><i class="fas fa-spinner fa-spin me-2"></i> {{ loadingText | translate }}</span>
                  </button>
              </form>
              
              <div class="divider"><span>Ou continuer avec</span></div>
              <div class="social-buttons">
                  <button class="social-btn"><i class="fab fa-google"></i> Google</button>
                  <button class="social-btn"><i class="fab fa-github"></i> Github</button>
              </div>
          </div>

          <!-- ÉTAPE 2 : OTP VERIFICATION -->
          <div class="form-container w-100" style="max-width: 450px;" *ngIf="stepIndex === 2">
              <div class="text-center mb-4">
                   <div class="icon-circle mb-3 mx-auto">
                      <i class="fas fa-shield-alt"></i>
                   </div>
                   <h2 class="text-white">{{ 'Authentifiez votre compte' | translate }}</h2>
                   <p class="sub-text">{{ 'entrer le code de vérification' | translate }}</p>
                   
                   <p *ngIf="modeVerif === 1" class="text-sm text-green">
                      {{ 'un code envoyé mail' | translate }} <strong>{{ utilisateur.email || 'votre email' }}</strong>
                   </p>
                   <p *ngIf="modeVerif === 2" class="text-sm text-green">
                      {{ 'un code envoyé sms' | translate }} <strong>{{ utilisateur.telephone || 'votre mobile' }}</strong>
                   </p>
              </div>

              <!-- OTP Inputs -->
              <div class="d-flex justify-content-center gap-2 mb-5">
                  <ng-container *ngFor="let i of [0,1,2,3,4,5]">
                      <input #otpInput type="text" maxlength="1" 
                             class="otp-input modern-input text-center p-0"
                             [(ngModel)]="otpDigits[i]" 
                             (input)="onInput($event, i)"
                             (keydown.backspace)="onBackspace(i)"
                             autocomplete="off">
                      <span *ngIf="i === 2" class="text-muted align-self-center mx-1">-</span>
                  </ng-container>
              </div>

              <button class="submit-btn w-100 mb-4" (click)="verifierCode()" 
                      [disabled]="loading || otpValue.length < 6">
                  <span *ngIf="!loading">{{ 'verifier' | translate }}</span>
                  <span *ngIf="loading"><i class="fas fa-spinner fa-spin me-2"></i> {{ 'loading' | translate }}</span>
              </button>

              <div class="text-center text-muted">
                  <p class="mb-1">
                      {{ 'attendre_timer' | translate }} <span class="text-white fw-bold">{{ timerDisplay }}</span>
                  </p>
                  <p>
                      {{ 'pas recu de code' | translate }} 
                      <a class="forgot-link cursor-pointer" (click)="renvoyerCode()" 
                         [class.disabled]="timer > 0" [style.cursor]="timer > 0 ? 'not-allowed' : 'pointer'">
                         {{ 'renvoyer' | translate }}
                      </a>
                  </p>
                  <button class="btn btn-link text-muted mt-3 text-decoration-none btn-sm" (click)="stepIndex = 1">
                      <i class="fas fa-arrow-left me-1"></i> Retour à la connexion
                  </button>
              </div>
          </div>

      </div>
    </div>
    
    <!-- Loader Global -->
    <div *ngIf="waiter" class="loader-overlay">
      <div class="spinner-border text-success" role="status"></div>
    </div>
  </div>