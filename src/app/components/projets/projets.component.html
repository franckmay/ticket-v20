<p-menu #menuOptions [model]="options" [popup]="true">
    <ng-template pTemplate="item" let-item>
        <span [ngStyle]="{ 'color': item.color }" pTooltip="{{ item.pTooltip |translate }}" tooltipPosition="top">
            <i [class]="item.icon" [ngStyle]="{ 'color': item.color }"></i> &nbsp;
            <span>{{ item.label | translate }}</span>
        </span>
    </ng-template>
</p-menu>

<!-- --------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->

<div class="container-fluid p-0" *ngIf="pageByAction=='LIST'">
    <div class="card mb-4">
        <div class="filter-card p-3">
            <form (ngSubmit)="listProjet()">
                <div class="filters-wrapper">
                    <!-- Organisation Filter (Bootstrap Select) -->
                    <div class="filter-group">
                        <label class="form-label small text-muted mb-1">{{ 'Organisation' | translate }} <span
                                class="text-danger">*</span></label>
                        <select class="form-select form-select-sm filter-dropdown" [(ngModel)]="fparam.organisationID"
                            name="organisationID" (change)="proprietaireListByOrg(fparam.organisationID)">
                            <option value="" selected>
                                {{ 'all_organisation' | translate }}
                            </option>
                            <option *ngFor="let org of organisations" [ngValue]="org.organisationID">
                                {{ org.libelleFr }}
                            </option>
                        </select>
                    </div>

                    <!-- Proprietaire Filter -->
                    <div class="filter-group">
                        <label class="form-label small text-muted mb-1">{{ 'Proprietaire' | translate }}</label>
                        <select class="form-select form-select-sm filter-dropdown" [(ngModel)]="fparam.proprietaireID"
                            name="proprietaireID">
                            <option value="undefined" selected>
                                {{ 'selProp' | translate }}
                            </option>
                            <option *ngFor="let prop of proprietairesOrg" [ngValue]="prop.proprietaireID">
                                {{ prop.nom }}
                            </option>
                        </select>
                    </div>

                    <!-- Etat Filter -->
                    <div class="filter-group">
                        <label class="form-label small text-muted mb-1">{{ 'Etat' | translate }}</label>
                        <select class="form-select form-select-sm filter-dropdown" [(ngModel)]="fparam.etat"
                            name="etat">
                            <option value="undefined" selected>
                                {{ 'selEtat' | translate }}
                            </option>
                            <option *ngFor="let e of optionsEtat" [ngValue]="e.value">
                                {{ e.label }}
                            </option>
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div class="filter-group">
                        <label class="form-label small text-muted mb-1">{{ 'Status' | translate }}</label>
                        <select class="form-select form-select-sm filter-dropdown" [(ngModel)]="fparam.status"
                            name="status">
                            <option value="undefined" selected>
                                {{ 'selStatus' | translate }}
                            </option>
                            <option *ngFor="let s of optionsStatus" [ngValue]="s.value">
                                {{ s.label }}
                            </option>
                        </select>
                    </div>

                    <!-- Start Date (HTML5 Native Input) -->
                    <div class="filter-group">
                        <label class="form-label small text-muted mb-1">{{ 'Du' | translate }}</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                            <input type="date" class="form-control" [(ngModel)]="fparam.dateDebut" name="dateDebut"
                                placeholder="{{ 'dateDebut' | translate }}">
                        </div>
                    </div>

                    <!-- End Date (HTML5 Native Input) -->
                    <div class="filter-group">
                        <label class="form-label small text-muted mb-1">{{ 'Au' | translate }}</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                            <input type="date" class="form-control" [(ngModel)]="fparam.dateFin" name="dateFin"
                                placeholder="{{ 'dateFin' | translate }}">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="filter-group d-flex align-items-end pb-1">
                        <!-- Search Button -->
                        <button type="submit" class="btn btn-primary btn-sm me-1" pTooltip="{{'rechercher'|translate}}"
                            tooltipPosition="top">
                            <i class="pi pi-search"></i>
                        </button>

                        <!-- Reset Button -->
                        <button type="button" class="btn btn-secondary btn-sm" pTooltip="{{'reinitialiser'|translate}}"
                            tooltipPosition="top" (click)="resetFilters()">
                            <i class="pi pi-refresh"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row" *ngIf="projets.length > 0">
        <div class="row mt-2">
            <div class="col-12  d-flex justify-content-end">
                <p-button pTooltip="{{'Actualiser' | translate}}" tooltipPosition="top" [style]="{ height: '35px' }"
                    icon="fas fa-redo-alt er" (click)="reload()" styleClass="p-button-secondary">
                </p-button>&nbsp;&nbsp;
                <button (click)="create()" [style]="{ height: '35px' }" pButton pRipple type="button"
                    label="{{ 'New Project' | translate }}" icon="fas fa-plus" iconPos="left"
                    class="p-button-primary"></button>&nbsp;&nbsp;
            </div>
        </div>

        <!-- IMPLEMENTATION NOUVELLE DES TABS (p-tabs) -->
        <p-tabs value="0">
            <p-tablist>
                <p-tab value="0">
                    <i class="pi pi-th-large me-2"></i>
                    <span>{{ 'Card View' | translate }}</span>
                </p-tab>
                <p-tab value="1">
                    <i class="pi pi-table me-2"></i>
                    <span>{{ 'Table View' | translate }}</span>
                </p-tab>
            </p-tablist>

            <p-tabpanels>
                <!-- CARD VIEW PANEL -->
                <p-tabpanel value="0">
                    <div class="row row-cols-1 row-cols-md-4 g-2 overflow-auto p-3"
                        style="max-height: calc(68vh - 50px);">
                        <ng-container *ngFor="let p of projets">
                            <div class="col">
                                <div class="card cursor-pointer shadow-sm" style="min-height: 220px;">
                                    <!-- En-tête : fond primaire si sélectionné -->
                                    <div class="card-header d-flex justify-content-between align-items-start">
                                        <h6 class="card-title mb-1">
                                            <i class="fas fa-folder-open me-2"></i>{{ p.libelleFr }}
                                        </h6>
                                        <small>{{ p.code }}</small>
                                    </div>

                                    <!-- Corps -->
                                    <div class="card-body py-2">
                                        <p class="mb-1">
                                            <i class="fas fa-building me-1 text-secondary"></i>
                                            <small>{{ p.organisationLibelle }}</small>
                                        </p>
                                        <div class="mb-2">
                                            <span class="badge me-1"
                                                [ngClass]="{ 'bg-secondary': p.priorite < 4, 'bg-warning': p.priorite == 4 || p.priorite == 5, 'bg-danger': p.priorite > 5 }">
                                                {{'Priorité' | translate}}: {{ (p.prioriteLibelle) | translate }}
                                            </span>
                                            <span class="badge me-1"
                                                [ngClass]="{ 'bg-secondary': p.status == 10, 'bg-primary': p.status == 20, 'bg-success': p.status == 40, 'bg-dark': p.status == 50, 'bg-info': p.status == 30 }">
                                                {{'Status' | translate}}: {{ (p.statusLibelle) | translate }}
                                            </span>
                                        </div>
                                        <p class="mb-1 small">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            {{ p.dateDebut | date: 'shortDate' }} – {{ p.dateFin | date: 'shortDate' }}
                                        </p>
                                        <p class="mb-2 small">
                                            <i class="fas fa-clock me-1"></i>{{ p.duree }}
                                        </p>
                                    </div>

                                    <!-- Footer icônes -->
                                    <div class="card-footer bg-light d-flex justify-content-end">
                                        <button pButton pRipple type="button" icon="pi pi-eye"
                                            class="p-button-sm p-button-info p-button-text" (click)="getPJ(p, 'view')"
                                            pTooltip="View"></button>
                                        <button pButton pRipple type="button" icon="pi pi-pencil"
                                            class="p-button-sm p-button-success p-button-text  mx-2"
                                            (click)="getPJ(p, 'edit')" pTooltip="Edit"></button>
                                        <button pButton pRipple type="button" icon="pi pi-trash"
                                            class="p-button-sm p-button-danger p-button-text"
                                            (click)="confirmDelete(p)" pTooltip="Delete"></button>
                                    </div>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </p-tabpanel>

                <!-- TABLE VIEW PANEL -->
                <p-tabpanel value="1">
                    <p-table #dt [value]="projets" styleClass="p-datatable-sm p-datatable-striped"
                        [showCurrentPageReport]="true" [rows]="50" [scrollable]="true" [virtualScroll]="true"
                        [scrollHeight]="'60vh'"
                        [globalFilterFields]="['projetID', 'libelleFr', 'libelleUs', 'organisationID']"
                        [virtualScrollItemSize]="50" [(selection)]="selectedPa" selectionMode="single"
                        [rowHover]="true" dataKey="projetID"
                        [scrollable]="false">
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 3%; text-align: center">N°</th>
                                <th style="width: 15%;">{{ 'Proprietaire'|translate }}</th>
                                <th style="width: 27%;">{{ 'libelleFr'|translate }}</th>
                                <th style="width: 10%;">{{ 'Responsable'|translate }}</th>
                                <th style="width: 10%;">{{ 'lastupdate'|translate }}</th>
                                <th style="width: 15%;" class="text-center">{{ 'Status'|translate }} </th>
                                <th style="width: 15%;" class="text-center">{{ 'Etat'|translate }} </th>
                                <th style="width: 5%;" class="text-center"> <i class="fas fa-cog"></i> </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-item let-i="rowIndex">
                            <tr>
                                <td>{{i+1}}</td>
                                <td (click)="getPJ(item, 'edit')">{{ item.nom }} {{ item.prenom }}</td>
                                <td (click)="getPJ(item, 'edit')">{{ item.libelleFr }}</td>
                                <td (click)="getPJ(item, 'edit')">{{ item.user_update }}</td>
                                <td (click)="getPJ(item, 'edit')">{{ item.last_update | date:'longDate' }}</td>
                                <td (click)="getPJ(item, 'edit')" class="text-center">
                                    <span
                                        [ngClass]="{'enattente':item.status==10, 'encours':item.status==20, 'Réouvert':item.status==30, 'Résolu':item.status==40, 'Fermé':item.status==50}">
                                        <span *ngIf="item.status==10">{{ 'enattente'|translate }}</span>
                                        <span *ngIf="item.status==20">{{ 'en cours'|translate }}</span>
                                        <span *ngIf="item.status==30">{{ 'Réouvert'|translate }}</span>
                                        <span *ngIf="item.status==40">{{ 'Résolu'|translate }}</span>
                                        <span *ngIf="item.status==50">{{ 'Fermé'|translate }}</span>
                                    </span>
                                </td>
                                <td (click)="getPJ(item, 'edit')" class="text-center">
                                    <span
                                        [ngClass]="{'enattente':item.etat==10, 'encours':item.etat==20, 'Réouvert':item.etat==30, 'Résolu':item.etat==40, 'Fermé':item.etat==50}">
                                        <span *ngIf="item.etat==10">{{ 'enattente'|translate }}</span>
                                        <span *ngIf="item.etat==20">{{ 'en cours'|translate }}</span>
                                        <span *ngIf="item.etat==30">{{ 'Réouvert'|translate }}</span>
                                        <span *ngIf="item.etat==40">{{ 'Résolu'|translate }}</span>
                                        <span *ngIf="item.etat==50">{{ 'Fermé'|translate }}</span>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <i (click)="onDropdownPJ(item); menuOptions.toggle($event)"
                                        class="fas fa-ellipsis-h elemnt" pTooltip="Actions" tooltipPosition="left">
                                    </i>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabpanel>
            </p-tabpanels>
        </p-tabs>
    </div>

    <div *ngIf="projets.length  < 1" class="alert alert-info">
        <div class="row d-flex justify-content-center mb-2">
            {{ 'paTrouve' | translate }}
        </div>
        <div class="row ">
            <div class="col d-flex justify-content-center">
                <button icon="fas fa-plus" (click)="create()" label="{{ 'nouveau' | translate }}"
                    [style]="{ height: '35px' }" pButton pRipple type="button" iconPos="left"
                    class="p-button-primary"></button>
            </div>
        </div>
    </div>
</div>

<!-- --------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->

<div class="container-fluid texte" *ngIf="pageByAction=='CREATEPJ'">
    <app-projet-edit [projet]="projet" [action]="currentAction" (saveProjetEvent)="handleSaveProjet($event)"
        (backEvent)="handleBack()"></app-projet-edit>
</div>
<!-- --------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->

<p-dialog [(visible)]="deleteProjectDialog" [modal]="true" [style]="{width: '600px'}" [draggable]="true"
    [resizable]="false">
    <ng-template pTemplate="header">
        <span style="font-size: 22px; color: #dc3545;">{{ 'Confirmation de suppression de projet' | translate }}</span>
    </ng-template>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12">
                <h4 class="text-center mb-3 text-danger">
                    {{ "Attention : suppression définitive de projet" | translate }}
                </h4>
                <div class="alert alert-danger">
                    <p><strong>{{ "Cette opération entraînera :" | translate }}</strong></p>
                    <ul class="mb-3 pl-3">
                        <li>{{ "Suppression récursive de tous les tickets et leurs dépendances" | translate }}</li>
                        <li>{{ "Effacement complet des commentaires et pièces-jointes" | translate }}</li>
                        <li>{{ "Suppression des équipes, membres et configurations associées" | translate }}</li>
                        <li>{{ "Destruction des entrées de planning (sprints, releases)" | translate }}</li>
                        <li>{{ "Suppression des workflows et métadonnées spécifiques" | translate }}</li>
                    </ul>
                    <p class="mb-0">
                        <strong>
                            {{ "AUCUNE DONNÉE NE POURRA ÊTRE RESTAURÉE APRÈS CETTE ACTION" | translate }}
                        </strong>
                    </p>
                </div>
                <p class="text-center">{{ "Voulez-vous vraiment continuer ?" | translate }}</p>
            </div>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <div class="row justify-content-center">
            <button class="btn btn-secondary btn-sm mx-2" (click)="deleteProjectDialog = false">
                <i class="fa fa-times-circle"></i>&nbsp;{{ "Annuler" | translate }}
            </button>
            <button class="btn btn-danger btn-sm mx-2" (click)="deleteProject()">
                <i class="fas fa-trash"></i>&nbsp;{{ "Supprimer le projet" | translate }}
            </button>
        </div>
    </ng-template>
</p-dialog>


<!-- --------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
<p-confirmDialog header="{{'Please Confirm' | translate}}" icon="pi pi-exclamation-triangle"
    acceptLabel="{{'Oui' | translate}}" rejectLabel="{{'No' | translate}}" acceptIcon="pi pi-check"
    rejectIcon="pi pi-times" acceptButtonStyleClass="p-button-success" rejectButtonStyleClass="p-button-danger">
</p-confirmDialog>


<!-- SPINNER DE CHARGEMENT DU TREETABLE -->
<div class="progress-spinner" *ngIf="displaySpinner" style="z-index: 9999;">
    <div class="d-flex justify-content-center">
        <p-progressSpinner styleClass="custom-spinner" strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
    </div>
    <div class="d-flex justify-content-center affiche">
        <h6 style="color: rgb(255, 255, 255);z-index: 999;">{{ 'Chargement' | translate }}...</h6>
    </div>
</div>

<!-- Modale de success -->
<div *ngIf="displaySucces" class="modal-overlay">
    <div class="modal-content  alert alert-success">
        <h5 class="text-center">{{ 'Succes' | translate }}</h5>
        <p>{{ successMessage | translate}}</p>
        <div class="d-flex justify-content-center mt-4">
            <button class="btn btn-secondary mx-2" (click)="closeSucces()">{{ 'Non' | translate }}</button>
        </div>
    </div>
</div>

<!-- Modale de erreur -->
<div *ngIf="displayError" class="modal-overlay">
    <div class="modal-content alert alert-danger">
        <h5 class="text-center">{{ 'erreur' | translate }}</h5>
        <p>{{ errorMessage | translate}} </p>
        <div class="d-flex justify-content-center mt-4">
            <button class="btn btn-secondary mx-2" (click)="closeError()">{{ 'Fermer' | translate }}</button>
        </div>
    </div>
</div>